{% comment %}
  Luma Labs AI Skin Quiz
  Clean rewrite ‚Äî Shopify-idiomatic, CSP-safe, zero inline handlers.
  Product data is injected via a JSON data island, read by {% javascript %} block.
{% endcomment %}

{%- assign p_barrier = all_products['barrier-renew-moisturizer'] -%}
{%- assign p_arbutin = all_products['2-percent-alpha-arbutin-vitamin-c'] -%}
{%- assign p_sunscreen = all_products['matte-uv-defence-spf-50'] -%}
{%- assign p_bundle = all_products['complete-luma-protocol'] -%}

{%- comment -%} Images ‚Äî prepend https to ensure display {%- endcomment -%}
{%- if p_barrier.featured_image -%}
  {%- assign barrier_img = p_barrier.featured_image | image_url: width: 800 | prepend: 'https:' -%}
{%- else -%}
  {%- assign barrier_img = '' -%}
{%- endif -%}
{%- if p_arbutin.featured_image -%}
  {%- assign arbutin_img = p_arbutin.featured_image | image_url: width: 800 | prepend: 'https:' -%}
{%- else -%}
  {%- assign arbutin_img = '' -%}
{%- endif -%}
{%- if p_sunscreen.featured_image -%}
  {%- assign sunscreen_img = p_sunscreen.featured_image | image_url: width: 800 | prepend: 'https:' -%}
{%- else -%}
  {%- assign sunscreen_img = '' -%}
{%- endif -%}
{%- if p_bundle.featured_image -%}
  {%- assign bundle_img = p_bundle.featured_image | image_url: width: 800 | prepend: 'https:' -%}
{%- else -%}
  {%- assign bundle_img = '' -%}
{%- endif -%}

{%- comment -%} Prices and Names ‚Äî NO PLACEHOLDERS {%- endcomment -%}
{%- if p_barrier.id != blank -%}
  {%- assign barrier_price = p_barrier.price | money -%}
  {%- assign barrier_name = p_barrier.title -%}
  {%- assign barrier_vid = p_barrier.variants.first.id -%}
{%- else -%}
  {%- assign barrier_price = '' -%}
  {%- assign barrier_name = '' -%}
  {%- assign barrier_vid = 0 -%}
{%- endif -%}

{%- if p_arbutin.id != blank -%}
  {%- assign arbutin_price = p_arbutin.price | money -%}
  {%- assign arbutin_name = p_arbutin.title -%}
  {%- assign arbutin_vid = p_arbutin.variants.first.id -%}
{%- else -%}
  {%- assign arbutin_price = '' -%}
  {%- assign arbutin_name = '' -%}
  {%- assign arbutin_vid = 0 -%}
{%- endif -%}

{%- if p_sunscreen.id != blank -%}
  {%- assign sunscreen_price = p_sunscreen.price | money -%}
  {%- assign sunscreen_name = p_sunscreen.title -%}
  {%- assign sunscreen_vid = p_sunscreen.variants.first.id -%}
{%- else -%}
  {%- assign sunscreen_price = '' -%}
  {%- assign sunscreen_name = '' -%}
  {%- assign sunscreen_vid = 0 -%}
{%- endif -%}

{%- if p_bundle.id != blank -%}
  {%- assign bundle_price = p_bundle.price | money -%}
  {%- assign bundle_name = p_bundle.title -%}
  {%- assign bundle_vid = p_bundle.variants.first.id -%}
{%- else -%}
  {%- assign bundle_price = '' -%}
  {%- assign bundle_name = '' -%}
  {%- assign bundle_vid = 0 -%}
{%- endif -%}

<!-- Product data island ‚Äî read by JS below -->
<script id="lsq-product-data" type="application/json">
  {
    "webhookUrl": {{ section.settings.webhook_url | json }},
    "products": {
      "barrier": {
        "name":        {{ barrier_name | json }},
        "price":       {{ barrier_price | json }},
        "img":         {{ barrier_img | json }},
        "variantId":   {{ barrier_vid }},
        "code":        "DATA10",
        "discountTag": "10% Code Applied!",
        "handle":      "barrier-renew",
        "bg":          "#E0EDF8",
        "actives":     "Triple Ceramides + Matrixyl 3000",
        "sub":         "Your stratum corneum requires immediate structural reconstruction.",
        "desc":        "Your lipid barrier is compromised and allowing hydration to escape. This biomimetic lipid formula physically patches micro-tears while remaining light enough for your skin type.",
        "ghlTrack":    "quiz_result_barrier"
      },
      "arbutin": {
        "name":        {{ arbutin_name | json }},
        "price":       {{ arbutin_price | json }},
        "img":         {{ arbutin_img | json }},
        "variantId":   {{ arbutin_vid }},
        "code":        "DATA10",
        "discountTag": "10% Code Applied!",
        "handle":      "alpha-arbutin",
        "bg":          "#FDF0C8",
        "actives":     "5-Pathway Pigment Interruption",
        "sub":         "Gentle but effective approach to fade hyperpigmentation.",
        "desc":        "Because your barrier is intact and handles actives well, we can safely deploy our most potent brightening compound. This serum shuts down melanin production at the source.",
        "ghlTrack":    "quiz_result_arbutin"
      },
      "sunscreen": {
        "name":        {{ sunscreen_name | json }},
        "price":       {{ sunscreen_price | json }},
        "img":         {{ sunscreen_img | json }},
        "variantId":   {{ sunscreen_vid }},
        "code":        "DATA10",
        "discountTag": "10% Code Applied!",
        "handle":      "matte-uv-defense",
        "bg":          "#FEF7E6",
        "actives":     "Next-Gen Organic Filters + Niacinamide 5%",
        "sub":         "Your primary goal requires uncompromising daily photoprotection.",
        "desc":        "To prevent structural aging, SPF is your highest priority active. This non-comedogenic hydrogel defends against UV degradation while actively repairing inflammation with Niacinamide.",
        "ghlTrack":    "quiz_result_sunscreen"
      },
      "bundle": {
        "name":        {{ bundle_name | json }},
        "price":       {{ bundle_price | json }},
        "img":         {{ bundle_img | json }},
        "variantId":   {{ bundle_vid }},
        "code":        "DATA15",
        "discountTag": "15% Bundle Code!",
        "handle":      "bundle",
        "bg":          "#F5F5F5",
        "actives":     "Barrier + Brightening + UV Defence",
        "sub":         "A comprehensive 360 degrees protocol optimized for your skin goals.",
        "desc":        "You requested the maximalist approach. This 3-step synergy targets pigment production, reconstructs your lipid barrier, and provides a hydrogel shield against UV triggers.",
        "ghlTrack":    "quiz_result_bundle"
      }
    }
  }
</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HTML ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<div class="lsq">
  <!-- Header -->
  <header class="lsq__header">
    <a href="/" class="lsq__logo">‚ú¶ Luma <span>Labs</span></a>
    <a href="/" class="lsq__exit">‚Üê Back to store</a>
  </header>

  <!-- Progress bar -->
  <div class="lsq__progress-track"><div class="lsq__progress-fill" id="LsqProgress"></div></div>

  <main class="lsq__main">
    <!-- Step 1 -->
    <div class="lsq__step lsq__step--active" data-step="1">
      <div class="lsq__step-header">
        <span class="lsq__counter">Question 01 of 05</span>
        <h1 class="lsq__title">
          What is your primary goal<br>
          for your skin right now?
        </h1>
        <p class="lsq__sub">This determines the core active ingredient for your routine.</p>
      </div>
      <div class="lsq__options">
        <label class="lsq__option">
          <input type="radio" name="q1" value="repair">
          <div class="lsq__card">
            <div class="lsq__card-left">
              <span class="lsq__icon">‚äï</span>
              <div>
                <strong>Repair damage & soothe redness.</strong
                ><small>My barrier feels compromised, tight, or flaking.</small>
              </div>
            </div>
            <span class="lsq__check">‚úì</span>
          </div>
        </label>
        <label class="lsq__option">
          <input type="radio" name="q1" value="fade">
          <div class="lsq__card">
            <div class="lsq__card-left">
              <span class="lsq__icon">‚óé</span>
              <div>
                <strong>Fade stubborn dark spots.</strong
                ><small>Targeting hyperpigmentation, post-acne marks, or melasma.</small>
              </div>
            </div>
            <span class="lsq__check">‚úì</span>
          </div>
        </label>
        <label class="lsq__option">
          <input type="radio" name="q1" value="prevent">
          <div class="lsq__card">
            <div class="lsq__card-left">
              <span class="lsq__icon">‚äõ</span>
              <div>
                <strong>Prevent aging & protect.</strong
                ><small>Maintaining structural integrity and defending against daily UV.</small>
              </div>
            </div>
            <span class="lsq__check">‚úì</span>
          </div>
        </label>
      </div>
      <div class="lsq__nav">
        <button class="lsq__btn lsq__btn--next lsq__btn--disabled" data-next="2">Continue ‚Üí</button>
      </div>
    </div>

    <!-- Step 2 -->
    <div class="lsq__step" data-step="2">
      <div class="lsq__step-header">
        <span class="lsq__counter">Question 02 of 05</span>
        <h1 class="lsq__title">By mid-day, how does your skin usually feel?</h1>
        <div class="lsq__note lsq__note--blue">
          ‚Ñπ <strong>Lab Note:</strong> Mid-day oil levels are the best indicator of your true skin type.
        </div>
      </div>
      <div class="lsq__options">
        <label class="lsq__option">
          <input type="radio" name="q2" value="tight">
          <div class="lsq__card">
            <div class="lsq__card-left"><strong>Tight, dry, and thirsty.</strong></div>
            <span class="lsq__check">‚úì</span>
          </div>
        </label>
        <label class="lsq__option">
          <input type="radio" name="q2" value="oily">
          <div class="lsq__card">
            <div class="lsq__card-left"><strong>Oily, shiny, or congested.</strong></div>
            <span class="lsq__check">‚úì</span>
          </div>
        </label>
        <label class="lsq__option">
          <input type="radio" name="q2" value="combo">
          <div class="lsq__card">
            <div class="lsq__card-left"><strong>Combination (Oily T-zone, dry cheeks).</strong></div>
            <span class="lsq__check">‚úì</span>
          </div>
        </label>
      </div>
      <div class="lsq__nav">
        <button class="lsq__btn lsq__btn--back" data-back="1">‚Üê</button>
        <button class="lsq__btn lsq__btn--next lsq__btn--disabled" data-next="3">Continue ‚Üí</button>
      </div>
    </div>

    <!-- Step 3 -->
    <div class="lsq__step" data-step="3">
      <div class="lsq__step-header">
        <span class="lsq__counter">Question 03 of 05</span>
        <h1 class="lsq__title">How does your skin react to strong active ingredients?</h1>
        <div class="lsq__note lsq__note--red">
          ‚ö† <strong>Lab Note:</strong> Stinging from standard actives (like Vitamin C) typically signals a compromised
          skin barrier.
        </div>
      </div>
      <div class="lsq__options">
        <label class="lsq__option">
          <input type="radio" name="q3" value="stings">
          <div class="lsq__card">
            <div class="lsq__card-left"><strong>It regularly stings, turns red, or breaks out.</strong></div>
            <span class="lsq__check">‚úì</span>
          </div>
        </label>
        <label class="lsq__option">
          <input type="radio" name="q3" value="handles">
          <div class="lsq__card">
            <div class="lsq__card-left"><strong>It handles new ingredients perfectly fine.</strong></div>
            <span class="lsq__check">‚úì</span>
          </div>
        </label>
      </div>
      <div class="lsq__nav">
        <button class="lsq__btn lsq__btn--back" data-back="2">‚Üê</button>
        <button class="lsq__btn lsq__btn--next lsq__btn--disabled" data-next="4">Continue ‚Üí</button>
      </div>
    </div>

    <!-- Step 4 -->
    <div class="lsq__step" data-step="4">
      <div class="lsq__step-header">
        <span class="lsq__counter">Question 04 of 05</span>
        <h1 class="lsq__title">How much sun exposure do you get on an average day?</h1>
      </div>
      <div class="lsq__options">
        <label class="lsq__option">
          <input type="radio" name="q4" value="low">
          <div class="lsq__card">
            <div class="lsq__card-left"><strong>Low (Mostly indoors, away from windows).</strong></div>
            <span class="lsq__check">‚úì</span>
          </div>
        </label>
        <label class="lsq__option">
          <input type="radio" name="q4" value="high">
          <div class="lsq__card">
            <div class="lsq__card-left"><strong>Moderate/High (Commuting, outdoors, near windows).</strong></div>
            <span class="lsq__check">‚úì</span>
          </div>
        </label>
      </div>
      <div class="lsq__nav">
        <button class="lsq__btn lsq__btn--back" data-back="3">‚Üê</button>
        <button class="lsq__btn lsq__btn--next lsq__btn--disabled" data-next="5">Continue ‚Üí</button>
      </div>
    </div>

    <!-- Step 5 -->
    <div class="lsq__step" data-step="5">
      <div class="lsq__step-header">
        <span class="lsq__counter">Question 05 of 05</span>
        <h1 class="lsq__title">Are you a skincare minimalist or maximalist?</h1>
        <p class="lsq__sub">This helps us recommend a routine you will actually stick to.</p>
      </div>
      <div class="lsq__options">
        <label class="lsq__option">
          <input type="radio" name="q5" value="minimal">
          <div class="lsq__card">
            <div class="lsq__card-left">
              <strong>Minimalist</strong><small>Just give me the single most important step.</small>
            </div>
            <span class="lsq__check">‚úì</span>
          </div>
        </label>
        <label class="lsq__option">
          <input type="radio" name="q5" value="maximal">
          <div class="lsq__card">
            <div class="lsq__card-left">
              <strong>Maximalist</strong><small>I want the complete 3-step synergy routine.</small>
            </div>
            <span class="lsq__check">‚úì</span>
          </div>
        </label>
      </div>
      <div class="lsq__nav">
        <button class="lsq__btn lsq__btn--back" data-back="4">‚Üê</button>
        <button class="lsq__btn lsq__btn--next lsq__btn--disabled" data-next="6">See My Results ‚Üí</button>
      </div>
    </div>

    <!-- Step 6: Lead Gate -->
    <div class="lsq__step" data-step="6">
      <div class="lsq__gate">
        <div class="lsq__gate-icon">‚öó</div>
        <h1 class="lsq__gate-title">Your profile is ready.</h1>
        <p class="lsq__gate-sub">
          Where should we send your personalized lab routine and your <strong>10% welcome code</strong>?
        </p>
        <form id="lsq-form" novalidate>
          <input type="text" id="lsq-name" class="lsq__input" placeholder="First Name" required>
          <input type="email" id="lsq-email" class="lsq__input" placeholder="Email Address" required>
          <button type="submit" class="lsq__submit">Unlock My Routine üîë</button>
        </form>
        <p class="lsq__privacy">We respect your inbox. Unsubscribe anytime.</p>
      </div>
    </div>

    <!-- Step 7: Loading + Result -->
    <div class="lsq__step lsq__step--result" data-step="7">
      <div class="lsq__loading" id="LsqLoading">
        <div class="lsq__spinner"></div>
        <h2>Analyzing your skin profile...</h2>
        <p class="lsq__loading-sub">Matching clinical actives</p>
      </div>
      <div class="lsq__result" id="LsqResult">
        <div class="lsq__result-header">
          <span class="lsq__match-badge">98% Match</span>
          <h2 class="lsq__result-title">Your Custom Protocol</h2>
          <p id="LsqResultSub"></p>
        </div>
        <div class="lsq__prescription">
          <div class="lsq__prescription-img" id="LsqImgWrap">
            <img id="LsqResultImg" src="" alt="Product" width="800" height="800">
          </div>
          <div class="lsq__prescription-details">
            <h3 id="LsqResultName"></h3>
            <span class="lsq__actives" id="LsqResultActives"></span>
            <h4>Why this works for your skin:</h4>
            <p id="LsqResultDesc"></p>
            <div class="lsq__cta-area">
              <div class="lsq__price-row">
                <span id="LsqResultPrice"></span>
                <span class="lsq__discount" id="LsqResultDiscountTag"></span>
              </div>
              <a href="#" id="LsqResultCta" class="lsq__cta-btn">Add to Routine ‚Üí</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

{% stylesheet %}
  .lsq {
    min-height: 100vh;
    background: #fafafa;
    color: #1a1a1a;
    font-family: 'Inter', Arial, sans-serif;
    display: flex;
    flex-direction: column;
    -webkit-font-smoothing: antialiased;
  }

  /* Header */
  .lsq__header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 50;
    padding: 20px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #e5e5e5;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(12px);
    box-sizing: border-box;
  }
  .lsq__logo {
    font-family: 'Playfair Display', Georgia, serif;
    font-size: 22px;
    font-weight: 500;
    color: #1a1a1a;
    text-decoration: none;
  }
  .lsq__logo span {
    font-family: 'Inter', Arial, sans-serif;
    font-weight: 300;
    font-size: 18px;
  }
  .lsq__exit {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: rgba(26, 26, 26, 0.5);
    text-decoration: none;
  }
  .lsq__exit:hover {
    color: #1a1a1a;
  }

  /* Progress */
  .lsq__progress-track {
    position: fixed;
    top: 73px;
    left: 0;
    width: 100%;
    height: 3px;
    background: #e5e5e5;
    z-index: 50;
  }
  .lsq__progress-fill {
    height: 100%;
    background: #1a1a1a;
    width: 16.6%;
    transition: width 0.5s ease;
  }

  /* Main layout */
  .lsq__main {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 110px 16px 60px;
  }

  /* Steps */
  .lsq__step {
    display: none;
    width: 100%;
    max-width: 700px;
    margin: 0 auto;
    animation: lsqFade 0.4s ease-out;
  }
  .lsq__step--active {
    display: block;
  }
  .lsq__step--result {
    max-width: 900px;
  }
  @keyframes lsqFade {
    from {
      opacity: 0;
      transform: translateY(14px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Step header */
  .lsq__step-header {
    text-align: center;
    margin-bottom: 36px;
  }
  .lsq__counter {
    display: inline-block;
    background: rgba(229, 229, 229, 0.5);
    color: rgba(26, 26, 26, 0.6);
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    padding: 5px 14px;
    border-radius: 20px;
    margin-bottom: 18px;
  }
  .lsq__title {
    font-family: 'Playfair Display', Georgia, serif;
    font-size: clamp(26px, 5vw, 46px);
    margin: 0 0 14px;
    line-height: 1.15;
  }
  .lsq__sub {
    font-size: 14px;
    color: rgba(26, 26, 26, 0.6);
    margin: 0;
  }
  .lsq__note {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    padding: 8px 16px;
    border-radius: 8px;
    margin-top: 8px;
  }
  .lsq__note--blue {
    background: #eff6ff;
    border: 1px solid #bfdbfe;
    color: #1e40af;
  }
  .lsq__note--red {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #991b1b;
  }

  /* Options */
  .lsq__options {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .lsq__option {
    display: block;
    cursor: pointer;
    position: relative;
  }
  .lsq__option input[type='radio'] {
    position: absolute;
    opacity: 0;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    margin: 0;
    cursor: pointer;
    z-index: 1;
  }
  .lsq__card {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 22px;
    border-radius: 14px;
    border: 1px solid #e5e5e5;
    background: #fff;
    transition: border-color 0.25s, box-shadow 0.25s;
  }
  .lsq__option input:checked ~ .lsq__card {
    border-color: #1a1a1a;
    background: #fafafa;
    box-shadow: 0 6px 20px -6px rgba(0, 0, 0, 0.08);
  }
  .lsq__card-left {
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .lsq__icon {
    width: 46px;
    height: 46px;
    border-radius: 50%;
    background: #f5f5f5;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
    transition: background 0.25s, color 0.25s;
  }
  .lsq__option input:checked ~ .lsq__card .lsq__icon {
    background: #1a1a1a;
    color: #fff;
  }
  .lsq__card strong {
    display: block;
    font-family: 'Playfair Display', Georgia, serif;
    font-size: 17px;
    font-weight: 400;
    color: #1a1a1a;
  }
  .lsq__card small {
    display: block;
    font-size: 12px;
    color: rgba(26, 26, 26, 0.55);
    margin-top: 2px;
  }
  .lsq__check {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #1a1a1a;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 12px;
    opacity: 0;
    transform: scale(0.5);
    transition: opacity 0.25s, transform 0.25s;
    flex-shrink: 0;
  }
  .lsq__option input:checked ~ .lsq__card .lsq__check {
    opacity: 1;
    transform: scale(1);
  }

  /* Nav */
  .lsq__nav {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    margin-top: 40px;
  }
  .lsq__btn--back {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #fff;
    border: 1px solid #e5e5e5;
    cursor: pointer;
    font-size: 18px;
    color: #1a1a1a;
    transition: background 0.2s;
  }
  .lsq__btn--back:hover {
    background: #f5f5f5;
  }
  .lsq__btn--next {
    font-family: 'Inter', Arial, sans-serif;
    font-size: 13px;
    font-weight: 600;
    padding: 16px 36px;
    border-radius: 50px;
    border: none;
    cursor: pointer;
    transition: all 0.25s;
  }
  .lsq__btn--disabled {
    background: #e5e5e5;
    color: rgba(26, 26, 26, 0.4);
    cursor: not-allowed;
  }
  .lsq__btn--active {
    background: #1a1a1a;
    color: #fff;
    box-shadow: 0 4px 16px -4px rgba(0, 0, 0, 0.25);
  }
  .lsq__btn--active:hover {
    background: #d4a340;
  }

  /* Gate */
  .lsq__gate {
    background: #fff;
    border: 1px solid #e5e5e5;
    border-radius: 28px;
    padding: clamp(36px, 6vw, 60px);
    text-align: center;
    max-width: 500px;
    margin: 0 auto;
    box-shadow: 0 20px 60px -20px rgba(0, 0, 0, 0.08);
  }
  .lsq__gate-icon {
    width: 60px;
    height: 60px;
    background: #1a1a1a;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
    font-size: 26px;
    color: #fff;
  }
  .lsq__gate-title {
    font-family: 'Playfair Display', Georgia, serif;
    font-size: clamp(24px, 4vw, 36px);
    margin: 0 0 10px;
  }
  .lsq__gate-sub {
    font-size: 14px;
    color: rgba(26, 26, 26, 0.65);
    margin: 0 0 24px;
    line-height: 1.65;
  }
  .lsq__input {
    width: 100%;
    background: #fafafa;
    border: 1px solid #e5e5e5;
    padding: 15px 18px;
    border-radius: 10px;
    font-size: 14px;
    color: #1a1a1a;
    margin-bottom: 10px;
    box-sizing: border-box;
    transition: border-color 0.2s;
  }
  .lsq__input:focus {
    outline: none;
    border-color: #1a1a1a;
  }
  .lsq__submit {
    width: 100%;
    background: #1a1a1a;
    color: #fff;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    padding: 17px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    transition: background 0.2s;
    margin-top: 6px;
  }
  .lsq__submit:hover {
    background: #d4a340;
  }
  .lsq__privacy {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    font-weight: 600;
    color: rgba(26, 26, 26, 0.35);
    margin: 18px 0 0;
  }

  /* Loading */
  .lsq__loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 60px 0;
  }
  .lsq__spinner {
    width: 46px;
    height: 46px;
    border: 3px solid rgba(26, 26, 26, 0.1);
    border-top-color: #1a1a1a;
    border-radius: 50%;
    animation: lsqSpin 1s linear infinite;
    margin-bottom: 24px;
  }
  @keyframes lsqSpin {
    to {
      transform: rotate(360deg);
    }
  }
  .lsq__loading h2 {
    font-family: 'Playfair Display', Georgia, serif;
    font-size: 22px;
    margin: 0 0 8px;
  }
  .lsq__loading-sub {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: rgba(26, 26, 26, 0.4);
    font-weight: 700;
    animation: lsqPulse 1.5s ease-in-out infinite;
  }
  @keyframes lsqPulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.3;
    }
  }

  /* Result */
  .lsq__result {
    display: none;
    animation: lsqFade 0.5s ease forwards;
  }
  .lsq__result-header {
    text-align: center;
    margin-bottom: 36px;
  }
  .lsq__match-badge {
    display: inline-block;
    background: #dcfce7;
    color: #166534;
    border: 1px solid #bbf7d0;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    padding: 5px 16px;
    border-radius: 20px;
    margin-bottom: 14px;
  }
  .lsq__result-title {
    font-family: 'Playfair Display', Georgia, serif;
    font-size: clamp(30px, 5vw, 52px);
    margin: 0 0 10px;
  }
  .lsq__prescription {
    background: #fff;
    border-radius: 22px;
    border: 1px solid #e5e5e5;
    overflow: hidden;
    box-shadow: 0 16px 48px -16px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
  }
  @media (min-width: 768px) {
    .lsq__prescription {
      flex-direction: row;
    }
  }
  .lsq__prescription-img {
    width: 100%;
    min-height: 240px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }
  @media (min-width: 768px) {
    .lsq__prescription-img {
      width: 50%;
      min-height: 400px;
    }
  }
  .lsq__prescription-img img {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
    transition: transform 0.7s;
  }
  .lsq__prescription:hover img {
    transform: scale(1.04);
  }
  .lsq__prescription-details {
    width: 100%;
    padding: clamp(26px, 4vw, 50px);
    display: flex;
    flex-direction: column;
    justify-content: center;
    background: #fafafa;
    box-sizing: border-box;
  }
  @media (min-width: 768px) {
    .lsq__prescription-details {
      width: 50%;
    }
  }
  .lsq__prescription-details h3 {
    font-family: 'Playfair Display', Georgia, serif;
    font-size: clamp(22px, 3vw, 32px);
    margin: 0 0 6px;
  }
  .lsq__actives {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: rgba(26, 26, 26, 0.45);
    display: block;
    border-bottom: 1px solid #e5e5e5;
    padding-bottom: 16px;
    margin-bottom: 16px;
  }
  .lsq__prescription-details h4 {
    font-family: 'Playfair Display', Georgia, serif;
    font-size: 16px;
    margin: 0 0 8px;
  }
  .lsq__prescription-details p {
    font-size: 13px;
    color: rgba(26, 26, 26, 0.7);
    line-height: 1.7;
    margin: 0 0 24px;
  }
  .lsq__cta-area {
    border-top: 1px solid #e5e5e5;
    padding-top: 20px;
  }
  .lsq__price-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 14px;
  }
  .lsq__price-row span:first-child {
    font-family: 'Playfair Display', Georgia, serif;
    font-size: 22px;
    color: #1a1a1a;
  }
  .lsq__discount {
    font-size: 11px;
    font-weight: 700;
    background: #dcfce7;
    color: #166534;
    padding: 3px 10px;
    border-radius: 20px;
  }
  .lsq__cta-btn {
    display: block;
    background: #1a1a1a;
    color: #fff;
    text-align: center;
    padding: 15px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 700;
    text-decoration: none;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    transition: background 0.2s;
  }
  .lsq__cta-btn:hover {
    background: #d4a340;
  }
{% endstylesheet %}

{% javascript %}
  (function () {
    // Read product data from JSON island
    var dataEl = document.getElementById('lsq-product-data');
    if (!dataEl) return;
    var cfg;
    try {
      cfg = JSON.parse(dataEl.textContent);
    } catch (e) {
      return;
    }

    var PRODUCTS = cfg.products;
    var WEBHOOK_URL = cfg.webhookUrl;
    var answers = {};
    var TOTAL = 5;

    // ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function qs(sel) {
      return document.querySelector(sel);
    }
    function qsa(sel) {
      return document.querySelectorAll(sel);
    }

    function showStep(n) {
      qsa('.lsq__step').forEach(function (el) {
        el.classList.remove('lsq__step--active');
      });
      var target = qs('.lsq__step[data-step="' + n + '"]');
      if (!target) return;
      target.classList.add('lsq__step--active');
      qs('#LsqProgress').style.width = (n / (TOTAL + 1)) * 100 + '%';
      // Restore button if already answered
      var qKey = 'q' + n;
      if (answers[qKey]) enableBtn(n);
    }

    function enableBtn(step) {
      var btn = qs('[data-step="' + step + '"] .lsq__btn--next');
      if (btn) {
        btn.classList.remove('lsq__btn--disabled');
        btn.classList.add('lsq__btn--active');
      }
    }

    function recommend() {
      var q1 = answers.q1,
        q3 = answers.q3,
        q5 = answers.q5;
      if (q5 === 'maximal') return 'bundle';
      if (q3 === 'stings') return 'barrier';
      if (q1 === 'repair') return 'barrier';
      if (q1 === 'fade' && q3 === 'handles') return 'arbutin';
      if (q1 === 'prevent') return 'sunscreen';
      return 'barrier';
    }

    function fillResult(data, headline, reason) {
      // Build direct-to-cart URL with discount pre-applied
      var ctaUrl;
      if (data.variantId && data.variantId !== 0) {
        ctaUrl = '/cart/' + data.variantId + ':1?discount=' + data.code;
      } else {
        ctaUrl = '/collections/all';
      }

      qs('#LsqResultSub').textContent = headline;
      qs('#LsqResultName').textContent = data.name;
      qs('#LsqResultActives').textContent = data.actives;
      qs('#LsqResultDesc').textContent = reason;
      qs('#LsqResultPrice').textContent = data.price;
      qs('#LsqResultDiscountTag').textContent = data.discountTag;
      qs('#LsqResultImg').src = data.img;
      qs('#LsqResultImg').alt = data.name;
      qs('#LsqResultCta').href = ctaUrl;
      qs('#LsqImgWrap').style.background = data.bg;
      qs('#LsqLoading').style.display = 'none';
      qs('#LsqResult').style.display = 'block';
    }

    // ‚îÄ‚îÄ‚îÄ Event: option cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    qsa('.lsq__option').forEach(function (label) {
      var radio = label.querySelector('input[type="radio"]');
      if (!radio) return;

      function onPick() {
        var name = radio.name; // "q1" ‚Ä¶ "q5"
        var step = parseInt(name.replace('q', ''), 10);
        answers[name] = radio.value;
        enableBtn(step);
      }

      label.addEventListener('click', function () {
        // Let browser check the radio first, then read its value
        setTimeout(onPick, 0);
      });
      radio.addEventListener('change', onPick);
    });

    // ‚îÄ‚îÄ‚îÄ Event: next buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    qsa('[data-next]').forEach(function (btn) {
      btn.addEventListener('click', function () {
        if (btn.classList.contains('lsq__btn--disabled')) return;
        showStep(parseInt(btn.getAttribute('data-next'), 10));
      });
    });

    // ‚îÄ‚îÄ‚îÄ Event: back buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    qsa('[data-back]').forEach(function (btn) {
      btn.addEventListener('click', function () {
        showStep(parseInt(btn.getAttribute('data-back'), 10));
      });
    });

    // ‚îÄ‚îÄ‚îÄ Event: form submit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var form = document.getElementById('lsq-form');
    if (form) {
      form.addEventListener('submit', function (e) {
        e.preventDefault();
        var name = document.getElementById('lsq-name').value.trim();
        var email = document.getElementById('lsq-email').value.trim();
        if (!name || !email) return;

        var rec = recommend();
        var data = PRODUCTS[rec];

        var labelMap = {
          q1: { repair: 'Repair & Soothe', fade: 'Fade Dark Spots', prevent: 'Prevent Aging' },
          q2: { tight: 'Tight/Dry', oily: 'Oily/Shiny', combo: 'Combination' },
          q3: { stings: 'Sensitive/Stings', handles: 'Tolerant/Handles Actives' },
          q4: { low: 'Low Exposure', high: 'High Exposure' },
          q5: { minimal: 'Minimalist', maximal: 'Maximalist' },
        };

        var payload = {
          first_name: name,
          email: email,
          recommendation: rec,
          ghl_tag: data.ghlTrack,
          shopify_tags: 'skin-quiz, ' + data.handle,
          discount_code: data.code,
          q1: answers.q1,
          q1_label: labelMap.q1[answers.q1] || answers.q1,
          q2: answers.q2,
          q2_label: labelMap.q2[answers.q2] || answers.q2,
          q3: answers.q3,
          q3_label: labelMap.q3[answers.q3] || answers.q3,
          q4: answers.q4,
          q4_label: labelMap.q4[answers.q4] || answers.q4,
          q5: answers.q5,
          q5_label: labelMap.q5[answers.q5] || answers.q5,
        };

        // Show loading
        showStep(7);

        // Register customer in Shopify via account creation form
        // This creates an actual Shopify customer record.
        // Note: Shopify storefront cannot set customer tags (admin-only).
        // Tags are applied by the webhook server via Admin API.
        var fd = new FormData();
        fd.append('form_type', 'create_customer');
        fd.append('utf8', '\u2713');
        fd.append('customer[first_name]', name);
        fd.append('customer[email]', email);
        fd.append('customer[password]', Math.random().toString(36).slice(2) + '!Luma1');
        fd.append('customer[password_confirmation]', fd.get('customer[password]'));
        fetch('/account', { method: 'POST', body: fd });

        // Fire webhook
        if (WEBHOOK_URL && WEBHOOK_URL.indexOf('YOUR') === -1) {
          fetch(WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Bypass-Tunnel-Reminder': 'true' },
            body: JSON.stringify(payload),
          })
            .then(function (r) {
              return r.json();
            })
            .then(function (res) {
              var ai = res.ai || {};
              fillResult(data, ai.headline || data.sub, ai.reason || data.desc);
            })
            .catch(function () {
              fillResult(data, data.sub, data.desc);
            });
        } else {
          setTimeout(function () {
            fillResult(data, data.sub, data.desc);
          }, 2400);
        }
      });
    }

    // Init
    showStep(1);
  })();
{% endjavascript %}

{% schema %}
{
  "name": "Luma AI Skin Quiz",
  "settings": [
    {
      "type": "text",
      "id": "webhook_url",
      "label": "Webhook URL",
      "placeholder": "https://your-endpoint.com/api/webhook/quiz",
      "info": "The quiz POSTs a JSON payload with all answers, recommendation, and customer info."
    }
  ],
  "presets": [{ "name": "Luma AI Skin Quiz" }]
}
{% endschema %}
