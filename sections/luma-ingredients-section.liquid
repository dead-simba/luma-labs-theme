{% schema %}
{
  "name": "Ingredients Accordion",
  "tag": "section",
  "class": "section-ingredients",
  "settings": [
    {
      "type": "header",
      "content": "Section Header"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Ingredients"
    },
    {
      "type": "header",
      "content": "Style Settings"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color",
      "default": "#FFFFFF"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#1A1A1A"
    },
    {
      "type": "color",
      "id": "accent_color",
      "label": "Accent Color (Plus Sign)",
      "default": "#D4A340"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 20,
      "max": 120,
      "step": 4,
      "unit": "px",
      "label": "Top Padding",
      "default": 60
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 20,
      "max": 120,
      "step": 4,
      "unit": "px",
      "label": "Bottom Padding",
      "default": 60
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "Section Width",
      "options": [
        { "value": "800px", "label": "Narrow (800px)" },
        { "value": "1280px", "label": "Standard (1280px)" },
        { "value": "100%", "label": "Full Width" }
      ],
      "default": "1280px"
    },
    {
      "type": "select",
      "id": "heading_alignment",
      "label": "Heading Alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" }
      ],
      "default": "left"
    },
    {
      "type": "header",
      "content": "Typography"
    },
    {
      "type": "checkbox",
      "id": "override_fonts",
      "label": "Override Theme Fonts",
      "default": false
    },
    {
      "type": "font_picker",
      "id": "heading_font",
      "label": "Heading Font",
      "default": "serif"
    },
    {
      "type": "font_picker",
      "id": "body_font",
      "label": "Body Font",
      "default": "sans-serif"
    }
  ],
  "blocks": [
    {
      "type": "ingredient",
      "name": "Ingredient Item",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Ingredient Name",
          "default": "1% Hyaluronic Acid (The Hydrator)"
        },
        {
          "type": "textarea",
          "id": "description",
          "label": "Description",
          "default": "Acts as a moisture sponge for your skin cells, ensuring deep hydration without clogging pores."
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Ingredients Accordion",
      "blocks": [
        {
          "type": "ingredient",
          "settings": {
            "title": "2% Alpha Arbutin",
            "description": "Derived from bearberry leaves, this tyrosinase inhibitor safely prevents the overproduction of melanin, fading dark spots without the cellular toxicity of hydroquinone."
          }
        },
        {
          "type": "ingredient",
          "settings": {
            "title": "3% Magnesium Ascorbyl Phosphate",
            "description": "A highly stable, non-irritating Vitamin C derivative that boosts collagen synthesis and amplifies the brightening effects of Alpha Arbutin."
          }
        },
        {
          "type": "ingredient",
          "settings": {
            "title": "Low Molecular Weight Hyaluronic Acid",
            "description": "Penetrates deep into the dermis to instantly plump fine lines and ensure active ingredients are properly absorbed."
          }
        },
        {
          "type": "ingredient",
          "settings": {
            "title": "Full Ingredients (INCI)",
            "description": "Aqua/Water/Eau, Alpha-Arbutin, Magnesium Ascorbyl Phosphate, Glycerin, Sodium Hyaluronate, Centella Asiatica Extract, Glycyrrhiza Glabra (Licorice) Root Extract, Panax Ginseng Root Extract, Camellia Sinensis Leaf Extract, Phenoxyethanol, Ethylhexylglycerin."
          }
        }
      ]
    }
  ]
}
{% endschema %}

{%- style -%}
  /* Font Loading */
  {%- if section.settings.override_fonts -%}
    {{ section.settings.heading_font | font_face: font_display: 'swap' }}
    {{ section.settings.body_font | font_face: font_display: 'swap' }}
  {%- endif -%}

  #shopify-section-{{ section.id }} .ingredients-section {
    background-color: {{ section.settings.bg_color }};
    padding-top: {{ section.settings.padding_top }}px;
    padding-bottom: {{ section.settings.padding_bottom }}px;
    color: {{ section.settings.text_color }};

    /* Body Font Logic */
    {%- if section.settings.override_fonts and section.settings.body_font != blank -%}
      font-family: {{ section.settings.body_font.family }}, {{ section.settings.body_font.fallback_families }};
    {%- elsif settings.type_body_font != blank -%}
      font-family: {{ settings.type_body_font.family }}, {{ settings.type_body_font.fallback_families }};
    {%- elsif settings.type_base_font != blank -%}
      font-family: {{ settings.type_base_font.family }}, {{ settings.type_base_font.fallback_families }};
    {%- else -%}
      font-family: inherit;
    {%- endif -%}
  }

  #shopify-section-{{ section.id }} .ingredients-container {
    max-width: {{ section.settings.section_width }};
    margin: 0 auto;
    padding: 0 20px;
  }

  /* Heading */
  #shopify-section-{{ section.id }} .ingredients-title {
    font-size: 36px;
    margin-bottom: 24px;
    font-weight: 400;
    line-height: 1.2;
    text-align: {{ section.settings.heading_alignment }};
    color: {{ section.settings.text_color }};

    /* Heading Font Logic */
    {%- if section.settings.override_fonts and section.settings.heading_font != blank -%}
      font-family: {{ section.settings.heading_font.family }}, {{ section.settings.heading_font.fallback_families }};
    {%- elsif settings.type_heading_font != blank -%}
      font-family: {{ settings.type_heading_font.family }}, {{ settings.type_heading_font.fallback_families }};
    {%- else -%}
      font-family: inherit;
    {%- endif -%}
  }

  /* Accordion Styles matching V3 */
  #shopify-section-{{ section.id }} .accordion-wrapper {
      margin-top: 32px;
  }

  #shopify-section-{{ section.id }} details.ingredient-item {
    border-bottom: 1px solid #e5e7eb;
    cursor: pointer;
  }

  #shopify-section-{{ section.id }} details.ingredient-item:last-child {
      border-bottom: 0;
  }

  #shopify-section-{{ section.id }} details.ingredient-item summary {
    list-style: none; /* Remove default triangle */
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px 0;
    transition: color 0.2s;
  }

  #shopify-section-{{ section.id }} details.ingredient-item summary:focus {
      outline: none;
  }

  #shopify-section-{{ section.id }} details.ingredient-item summary::-webkit-details-marker {
    display: none;
  }

  #shopify-section-{{ section.id }} .ingredient-name {
    font-size: 16px;
    font-weight: 700;
    color: {{ section.settings.text_color }};
    transition: color 0.3s;
  }

  #shopify-section-{{ section.id }} details.ingredient-item summary:hover .ingredient-name {
      color: {{ section.settings.accent_color }};
  }

  /* Right Toggle Icon (+ -> x animation) */
  #shopify-section-{{ section.id }} .icon-toggle {
    width: 24px;
    height: 24px;
    flex-shrink: 0;
    color: rgba(26, 26, 26, 0.4);
    transition: color 0.2s;
  }

  #shopify-section-{{ section.id }} details.ingredient-item[open] .icon-toggle {
    color: {{ section.settings.accent_color }};
  }

  /* Content */
  #shopify-section-{{ section.id }} .ingredient-content {
    padding-bottom: 24px;
    font-size: 14px;
    line-height: 1.6;
    color: rgba(26, 26, 26, 0.8);
    font-weight: 300;
  }
{%- endstyle -%}

<div class="ingredients-section" id="ingredients-section-{{ section.id }}">
  <div class="ingredients-container">
    {%- if section.settings.title != blank -%}
      <h2 class="ingredients-title">{{ section.settings.title | escape }}</h2>
    {%- endif -%}

    <div class="accordion-wrapper">
      {%- for block in section.blocks -%}
        <details class="ingredient-item" {{ block.shopify_attributes }}>
          <summary>
            <span class="ingredient-name">{{ block.settings.title | escape }}</span>
            <!-- Custom Plus/Minus SVG -->
            <svg class="icon-toggle" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" fill="currentColor">
              <path class="ing-path-plus" d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z"></path>
              <path class="ing-path-minus" d="M224,128a8,8,0,0,1-8,8H40a8,8,0,0,1,0-16H216A8,8,0,0,1,224,128Z" style="display:none;"></path>
            </svg>
          </summary>
          <div class="ingredient-content">
            {{ block.settings.description | escape }}
          </div>
        </details>
      {%- endfor -%}
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const ingRoot = document.getElementById('ingredients-section-{{ section.id }}');
    if (!ingRoot) return;

    const infDetailsElements = ingRoot.querySelectorAll('details.ingredient-item');

    infDetailsElements.forEach((detail) => {
      detail.addEventListener('toggle', function () {
        const plusPath = detail.querySelector('.ing-path-plus');
        const minusPath = detail.querySelector('.ing-path-minus');

        if (detail.hasAttribute('open')) {
          if (plusPath) plusPath.style.display = 'none';
          if (minusPath) minusPath.style.display = 'block';

          // Close others
          infDetailsElements.forEach((other) => {
            if (other !== detail && other.hasAttribute('open')) {
              other.removeAttribute('open');
            }
          });
        } else {
          if (plusPath) plusPath.style.display = 'block';
          if (minusPath) minusPath.style.display = 'none';
        }
      });
    });
  });
</script>
