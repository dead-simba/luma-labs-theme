{% style %}
  .luma-routine {
    padding: 6rem 1.5rem;
    background-color: #0a0a0a;
    color: #ffffff;
    position: relative;
    overflow: hidden;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }
  @media (min-width: 768px) {
    .luma-routine {
      padding: 8rem 2rem;
    }
  }

  .luma-routine__glow {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 50rem;
    height: 25rem;
    background-color: rgba(212, 163, 64, 0.05);
    border-radius: 9999px;
    mix-blend-mode: screen;
    filter: blur(100px);
    pointer-events: none;
    z-index: 0;
  }

  .luma-routine__container {
    max-width: 80rem;
    margin: 0 auto;
    position: relative;
    z-index: 1;
  }

  .luma-routine__header {
    text-align: center;
    max-width: 48rem;
    margin: 0 auto 5rem;
  }
  .luma-routine__heading {
    font-family: 'Playfair Display', serif;
    font-size: 2.25rem;
    margin-bottom: 1.5rem;
    color: #ffffff;
  }
  @media (min-width: 768px) {
    .luma-routine__heading {
      font-size: 3rem;
    }
  }
  @media (min-width: 1024px) {
    .luma-routine__heading {
      font-size: 3.75rem;
    }
  }
  .luma-routine__desc {
    font-family: 'Inter', sans-serif;
    color: rgba(255, 255, 255, 0.6);
    font-size: 1rem;
    font-weight: 300;
    line-height: 1.625;
  }
  @media (min-width: 768px) {
    .luma-routine__desc {
      font-size: 1.125rem;
    }
  }

  .luma-routine__grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 4rem;
    position: relative;
  }
  @media (min-width: 768px) {
    .luma-routine__grid {
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 2rem;
    }
  }

  .luma-routine__connector {
    display: none;
    position: absolute;
    top: 6.25rem;
    left: 16.66%;
    right: 16.66%;
    height: 1px;
    background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.2), transparent);
    z-index: 0;
  }
  @media (min-width: 768px) {
    .luma-routine__connector {
      display: block;
    }
  }

  .luma-routine__step {
    text-align: center;
    position: relative;
    z-index: 1;
  }
  .luma-routine__visual {
    position: relative;
    height: 12rem;
    margin-bottom: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  @media (min-width: 768px) {
    .luma-routine__visual {
      height: 14rem;
    }
  }

  .luma-routine__visual-glow {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 8rem;
    height: 8rem;
    border-radius: 9999px;
    opacity: 0.2;
    filter: blur(12px);
  }
  .luma-routine__visual-base {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 7rem;
    height: 7rem;
    border-radius: 9999px;
    background-color: #1a1a1a;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  }
  .luma-routine__visual-img {
    position: relative;
    z-index: 1;
    height: 120%;
    width: auto;
    object-fit: cover;
    border-radius: 0.75rem;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    border: 1px solid rgba(255, 255, 255, 0.05);
    animation: lumaFloat 6s ease-in-out infinite;
  }
  .luma-routine__visual-img--delay-1 {
    animation-delay: 1s;
  }
  .luma-routine__visual-img--delay-2 {
    animation-delay: 2s;
  }

  @keyframes lumaFloat {
    0% {
      transform: translateY(0px);
    }
    50% {
      transform: translateY(-8px);
    }
    100% {
      transform: translateY(0px);
    }
  }

  .luma-routine__badge {
    position: absolute;
    bottom: -0.75rem;
    left: 50%;
    transform: translateX(-50%);
    background-color: #0a0a0a;
    color: #d4a340;
    font-family: 'Playfair Display', serif;
    font-weight: 700;
    font-size: 1.125rem;
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 9999px;
    border: 1px solid rgba(212, 163, 64, 0.5);
    z-index: 2;
    box-shadow: 0 0 15px rgba(212, 163, 64, 0.2);
  }

  .luma-routine__step-heading {
    font-family: 'Playfair Display', serif;
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
  }
  .luma-routine__step-product {
    font-family: 'Inter', sans-serif;
    font-size: 0.625rem;
    color: #d4a340;
    text-transform: uppercase;
    letter-spacing: 0.25em;
    font-weight: 700;
    margin-bottom: 1rem;
  }
  .luma-routine__step-desc {
    font-family: 'Inter', sans-serif;
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.6);
    font-weight: 300;
    line-height: 1.625;
    max-width: 20rem;
    margin: 0 auto;
  }

  .luma-routine__bundle {
    margin-top: 5rem;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  @media (min-width: 768px) {
    .luma-routine__bundle {
      margin-top: 6rem;
    }
  }

  .luma-routine__btn {
    width: 100%;
    background-color: #ffffff;
    color: #0a0a0a;
    font-family: 'Inter', sans-serif;
    font-weight: 700;
    font-size: 0.875rem;
    padding: 1.25rem 2rem;
    border-radius: 9999px;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    box-shadow: 0 15px 30px rgba(255, 255, 255, 0.1);
  }
  @media (min-width: 640px) {
    .luma-routine__btn {
      width: auto;
      font-size: 1rem;
      padding: 1.5rem 3rem;
    }
  }
  .luma-routine__btn:hover {
    background-color: #d4a340;
    color: #ffffff;
    transform: translateY(-4px);
    box-shadow: 0 15px 30px rgba(212, 163, 64, 0.2);
  }
  .luma-routine__btn-price {
    font-weight: 700;
  }
  .luma-routine__btn-original {
    color: rgba(10, 10, 10, 0.4);
    text-decoration: line-through;
    font-weight: 500;
    transition: color 0.3s ease;
  }
  .luma-routine__btn:hover .luma-routine__btn-original {
    color: rgba(255, 255, 255, 0.6);
  }
  .luma-routine__savings {
    font-family: 'Inter', sans-serif;
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.5);
    margin-top: 1.5rem;
    text-transform: uppercase;
    letter-spacing: 0.25em;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .luma-routine__savings i {
    font-size: 1rem;
    color: #d4a340;
  }
{% endstyle %}

<section class="luma-routine">
  <div class="luma-routine__glow"></div>
  <div class="luma-routine__container">
    <div class="luma-routine__header">
      <h2 class="luma-routine__heading">{{ section.settings.heading }}</h2>
      <p class="luma-routine__desc">{{ section.settings.description }}</p>
    </div>

    <div class="luma-routine__grid">
      <div class="luma-routine__connector"></div>

      {% for block in section.blocks %}
        {% comment %} Auto-pick the product image from the mapped bundle products {% endcomment %}
        {% if forloop.index == 1 %}
          {% assign step_product = section.settings.bundle_product_1 %}
        {% elsif forloop.index == 2 %}
          {% assign step_product = section.settings.bundle_product_2 %}
        {% else %}
          {% assign step_product = section.settings.bundle_product_3 %}
        {% endif %}

        <div class="luma-routine__step">
          <div class="luma-routine__visual">
            <div class="luma-routine__visual-glow" style="background: {{ block.settings.circle_bg }};"></div>
            <div
              class="luma-routine__visual-base"
              style="{% if block.settings.enable_border %}border-color: rgba(212,163,64,0.3); box-shadow: 0 0 30px rgba(212,163,64,0.1);{% endif %}"
            ></div>

            {% if step_product != blank and step_product.featured_image != blank %}
              <img
                src="{{ step_product.featured_image | image_url: width: 600 }}"
                class="luma-routine__visual-img luma-routine__visual-img--delay-{{ forloop.index0 }}"
                width="300"
                height="400"
                loading="lazy"
                alt="{{ step_product.title | escape }}"
              >
            {% elsif block.settings.product_image != blank %}
              <img
                src="{{ block.settings.product_image | image_url: width: 600 }}"
                class="luma-routine__visual-img luma-routine__visual-img--delay-{{ forloop.index0 }}"
                width="300"
                height="400"
                loading="lazy"
                alt="{{ block.settings.heading | escape }}"
              >
            {% else %}
              <img
                src="https://images.unsplash.com/photo-1556228578-0d85b1a4d571?q=80&w=300&auto=format&fit=crop"
                class="luma-routine__visual-img luma-routine__visual-img--delay-{{ forloop.index0 }}"
                width="300"
                height="400"
                loading="lazy"
                alt="Product Mockup"
              >
            {% endif %}

            <div class="luma-routine__badge">0{{ forloop.index }}</div>
          </div>

          <h3 class="luma-routine__step-heading" style="color: {{ block.settings.heading_color }};">
            {{ block.settings.heading }}
          </h3>
          <p class="luma-routine__step-product">{{ block.settings.product_name }}</p>
          <p class="luma-routine__step-desc">{{ block.settings.description }}</p>
        </div>
      {% endfor %}
    </div>

    {% if section.settings.show_bundle %}
      <div class="luma-routine__bundle">
        <button onclick="addProtocolToCart()" class="luma-routine__btn" id="lumaProtocolBtn">
          <span>
            {{- section.settings.btn_text }} &mdash;
            <strong class="luma-routine__btn-price">{{ section.settings.bundle_price }}</strong></span
          >
          <span class="luma-routine__btn-original">{{ section.settings.original_price }}</span>
        </button>
        <p class="luma-routine__savings">
          <i class="ph-fill ph-tag"></i> <span>{{ section.settings.savings_text }}</span>
        </p>
      </div>
    {% endif %}
  </div>
</section>

{% if section.settings.show_bundle %}
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // Collect Variant IDs dynamically from the schema's assigned products
      const bundleVariants = [];
      {% if section.settings.bundle_product_1 != blank %}bundleVariants.push({ id: {{ section.settings.bundle_product_1.variants.first.id }}, quantity: 1 });{% endif %}
      {% if section.settings.bundle_product_2 != blank %}bundleVariants.push({ id: {{ section.settings.bundle_product_2.variants.first.id }}, quantity: 1 });{% endif %}
      {% if section.settings.bundle_product_3 != blank %}bundleVariants.push({ id: {{ section.settings.bundle_product_3.variants.first.id }}, quantity: 1 });{% endif %}

      window.addProtocolToCart = function() {
        const btn = document.getElementById('lumaProtocolBtn');
        if (!btn) return;

        if(bundleVariants.length === 0) {
          alert("Please map products in the Shopify Customizer to use the Complete Protocol Add-to-Cart functionality.");
          return;
        }

        const originalText = btn.innerHTML;
        btn.innerHTML = 'Adding to Cart... <i class="ph-bold ph-spinner luma-spin" style="animation: spin 1s linear infinite;"></i> <style>@keyframes spin { 100% { transform: rotate(360deg); } }</style>';
        btn.style.pointerEvents = 'none';

        fetch('/cart/add.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: bundleVariants })
        })
        .then(response => {
            if(response.ok) return response.json();
            throw new Error('Network response was not ok.');
        })
        .then(data => {
            btn.innerHTML = 'Added to Cart! <i class="ph-bold ph-check"></i>';
            btn.style.backgroundColor = '#16a34a'; // tailwind green-600 equivalent
            btn.style.color = '#FFFFFF';

            // Trigger Dawn's cart refresh or any global cart update
            document.documentElement.dispatchEvent(new CustomEvent('cart:refresh'));

            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.backgroundColor = '';
                btn.style.color = '';
                btn.style.pointerEvents = 'auto';
            }, 2500);
        })
        .catch((error) => {
            console.error('Error adding bundle:', error);
            btn.innerHTML = 'Error Adding Items <i class="ph-bold ph-warning"></i>';
            btn.style.backgroundColor = '#dc2626'; // tailwind red-600
            btn.style.color = '#FFFFFF';
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.backgroundColor = '';
                btn.style.color = '';
                btn.style.pointerEvents = 'auto';
            }, 2500);
        });
      }
    });
  </script>
{% endif %}

{% schema %}
{
  "name": "Collection Routine",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "The Complete Luma Protocol."
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description",
      "default": "While each formula is powerful alone, true clinical results require 360Â° exposome protection. Combine our three master formulas for complete skin transformation."
    },
    {
      "type": "header",
      "content": "Bundle Products Selection"
    },
    {
      "type": "product",
      "id": "bundle_product_1",
      "label": "Bundle Product 1"
    },
    {
      "type": "product",
      "id": "bundle_product_2",
      "label": "Bundle Product 2"
    },
    {
      "type": "product",
      "id": "bundle_product_3",
      "label": "Bundle Product 3"
    },
    {
      "type": "header",
      "content": "Bundle CTA"
    },
    {
      "type": "checkbox",
      "id": "show_bundle",
      "label": "Show Bundle CTA",
      "default": true
    },
    {
      "type": "text",
      "id": "btn_text",
      "label": "Button Text",
      "default": "Unlock The Complete Protocol"
    },
    {
      "type": "text",
      "id": "bundle_price",
      "label": "Bundle Price",
      "default": "$95.00"
    },
    {
      "type": "text",
      "id": "original_price",
      "label": "Original Price",
      "default": "$120.00"
    },
    {
      "type": "text",
      "id": "savings_text",
      "label": "Savings Text",
      "default": "Save $25 when you buy the system"
    }
  ],
  "blocks": [
    {
      "type": "step",
      "name": "Routine Step",
      "limit": 3,
      "settings": [
        {
          "type": "image_picker",
          "id": "product_image",
          "label": "Product Cutout Image (Transparent PNG)"
        },
        {
          "type": "text",
          "id": "heading",
          "label": "Heading",
          "default": "Target & Brighten"
        },
        {
          "type": "color",
          "id": "heading_color",
          "label": "Heading Color",
          "default": "#ffffff"
        },
        {
          "type": "text",
          "id": "product_name",
          "label": "Product Name",
          "default": "2% Alpha Arbutin Serum"
        },
        {
          "type": "textarea",
          "id": "description",
          "label": "Description",
          "default": "Apply to damp skin. Halts melanin production at the source through 5 biological pathways."
        },
        {
          "type": "text",
          "id": "circle_bg",
          "label": "Circle Glow Gradient",
          "default": "linear-gradient(135deg, #FDF0C8 0%, #F9C3B1 100%)"
        },
        {
          "type": "checkbox",
          "id": "enable_border",
          "label": "Enable Golden Border",
          "default": false
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Collection Routine",
      "blocks": [
        {
          "type": "step",
          "settings": {
            "heading": "Target & Brighten",
            "heading_color": "#ffffff",
            "product_name": "2% Alpha Arbutin Serum",
            "enable_border": false,
            "circle_bg": "linear-gradient(135deg, #FDF0C8 0%, #F9C3B1 100%)"
          }
        },
        {
          "type": "step",
          "settings": {
            "heading": "Seal & Repair",
            "heading_color": "#D4A340",
            "product_name": "Barrier Renew Gel-Cream",
            "enable_border": true,
            "circle_bg": "linear-gradient(135deg, #E0EDF8 0%, #E6DEF2 100%)"
          }
        },
        {
          "type": "step",
          "settings": {
            "heading": "Hydrate & Defend",
            "heading_color": "#ffffff",
            "product_name": "Hyaluronic Aqua Gel SPF 50",
            "enable_border": false,
            "circle_bg": "linear-gradient(135deg, #FEF7E6 0%, #F0F4F8 100%)"
          }
        }
      ]
    }
  ]
}
{% endschema %}
